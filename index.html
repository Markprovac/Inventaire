<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Application de gestion de stock de pi√®ces automobiles">
  <meta name="theme-color" content="#1e3a8a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%231e3a8a'/%3E%3Cpath fill='white' d='M96 48L48 72v48l48 24 48-24V72L96 48zm0 16l32 16v32l-32 16-32-16V80l32-16z'/%3E%3C/svg%3E">
  <title>Stock Pi√®ces Auto</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh}
    .hidden{display:none!important}
    #home{min-height:100vh;background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);padding:24px}
    .container{max-width:448px;margin:0 auto}
    .header{text-align:center;margin-bottom:32px;color:white}
    .icon-large{width:80px;height:80px;margin:0 auto 16px}
    h1{font-size:1.875rem;font-weight:bold;margin-bottom:8px}
    .subtitle{color:#bfdbfe}
    .button-group{display:flex;flex-direction:column;gap:16px}
    .btn{width:100%;padding:24px;font-size:1.25rem;font-weight:bold;border:none;border-radius:12px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:.2s;
      box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .btn:hover{transform:scale(1.05)}
    .btn-entry{background:#22c55e;color:white}.btn-entry:hover{background:#16a34a}
    .btn-exit{background:#ef4444;color:white}.btn-exit:hover{background:#dc2626}
    .btn-inventory{background:white;color:#1e3a8a}.btn-inventory:hover{background:#f3f4f6}
    .stats{margin-top:32px;text-align:center;color:#bfdbfe;font-size:.875rem}
    #scan{min-height:100vh;background:#111827;color:white;padding:16px}
    .scan-header{display:flex;justify-content:space-between;align-items:center}
    .scan-title{font-size:1.5rem;font-weight:bold}
    .btn-close{background:#ef4444;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-close:hover{background:#dc2626}
    #reader{width:100%;max-width:400px;margin:20px auto}
    .manual-input{background:#1f2937;padding:24px;border-radius:8px;margin-top:16px}
    .manual-input h3{font-size:1.125rem;margin-bottom:16px}
    .input-field{width:100%;background:#374151;color:white;border:none;padding:12px 16px;
      border-radius:8px;margin-bottom:16px;font-size:1rem}
    .input-field:focus{outline:2px solid #3b82f6}
    .quantity-control{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .btn-qty{background:#374151;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-qty:hover{background:#4b5563}
    .qty-input{width:80px;background:#374151;color:white;border:none;padding:8px 12px;border-radius:8px;
      text-align:center;font-size:1rem}
    .btn-submit{width:100%;padding:12px 24px;font-weight:bold;border:none;border-radius:8px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px}
    #inventory{min-height:100vh;background:#f9fafb}
    .inventory-header{background:#1e3a8a;color:white;padding:16px}
    .inventory-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .inventory-title{font-size:1.5rem;font-weight:bold}
    .btn-header-close{background:#1e40af;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-header-close:hover{background:#1e3a8a}
    .search-container{position:relative}
    .search-input{width:100%;background:white;color:#111827;border:none;padding:12px 16px 12px 40px;
      border-radius:8px;font-size:1rem}
    .search-input:focus{outline:2px solid #93c5fd}
    .inventory-content{padding:16px}
    .empty-state{text-align:center;color:#6b7280;padding:48px 0}
    .inventory-item{background:white;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .item-code{font-family:monospace;font-weight:600;color:#111827}
    .item-qty{background:#dbeafe;color:#1e3a8a;font-weight:bold;padding:8px 16px;border-radius:8px}
  </style>
</head>

<body>
  <!-- Page d'accueil -->
  <div id="home">
    <div class="container">
      <div class="header">
        <svg class="icon-large" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
        <h1>Stock Pi√®ces V√©hicule</h1>
        <p class="subtitle">Gestion simplifi√©e de votre inventaire</p>
      </div>
      <div class="button-group">
        <button class="btn btn-entry" onclick="showScan('entry')">ENTR√âES</button>
        <button class="btn btn-exit" onclick="showScan('exit')">SORTIES</button>
        <button class="btn btn-inventory" onclick="showInventory()">INVENTAIRE</button>
      </div>
      <div class="stats">
        <p><span id="refCount">0</span> r√©f√©rences en stock</p>
        <p><span id="totalCount">0</span> pi√®ces au total</p>
      </div>
    </div>
  </div>

  <!-- Page scan -->
  <div id="scan" class="hidden">
    <div class="scan-header">
      <h2 class="scan-title" id="scanTitle">ENTR√âE</h2>
      <button class="btn-close" onclick="showHome()">Fermer</button>
    </div>

    <div id="reader"></div>

    <div class="manual-input">
      <h3>Saisie manuelle</h3>
      <input type="text" id="manualInput" class="input-field" placeholder="R√©f√©rence ou code-barres">
      <div class="quantity-control">
        <button class="btn-qty" onclick="decreaseQty()">-</button>
        <input type="number" id="quantity" class="qty-input" value="1" min="1">
        <button class="btn-qty" onclick="increaseQty()">+</button>
      </div>
      <button id="btnSubmit" class="btn-submit btn-entry" onclick="handleSubmit()">Ajouter au stock</button>
    </div>
  </div>

  <!-- Page inventaire -->
  <div id="inventory" class="hidden">
    <div class="inventory-header">
      <div class="inventory-top">
        <h2 class="inventory-title">Inventaire</h2>
        <button class="btn-header-close" onclick="showHome()">Fermer</button>
      </div>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Rechercher..." oninput="filterInventory()">
      </div>
    </div>
    <div class="inventory-content">
      <div id="emptyState" class="empty-state">Aucune pi√®ce en stock</div>
      <div id="inventoryList"></div>
    </div>
  </div>

  <script>
    let inventory = {}, currentMode = null, html5QrCode = null;

    // Charger / sauvegarder
    function loadInventory() {
      const saved = localStorage.getItem('partsInventory');
      if (saved) inventory = JSON.parse(saved);
      updateStats();
    }
    function saveInventory() {
      localStorage.setItem('partsInventory', JSON.stringify(inventory));
      updateStats();
    }
    function updateStats() {
      const refCount = Object.keys(inventory).length;
      const totalCount = Object.values(inventory).reduce((a,b)=>a+b,0);
      document.getElementById('refCount').textContent = refCount;
      document.getElementById('totalCount').textContent = totalCount;
    }

    // Navigation
    function showHome(){
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('scan').classList.add('hidden');
      document.getElementById('inventory').classList.add('hidden');
      stopCamera();
    }
    function showScan(mode){
      currentMode=mode;
      document.getElementById('home').classList.add('hidden');
      document.getElementById('scan').classList.remove('hidden');
      document.getElementById('inventory').classList.add('hidden');
      document.getElementById('scanTitle').textContent=mode==='entry'?'ENTR√âE':'SORTIE';
      const btn=document.getElementById('btnSubmit');
      btn.textContent=mode==='entry'?'Ajouter au stock':'Retirer du stock';
      btn.className='btn-submit '+(mode==='entry'?'btn-entry':'btn-exit');
      startCamera();
    }
    function showInventory(){
      document.getElementById('home').classList.add('hidden');
      document.getElementById('scan').classList.add('hidden');
      document.getElementById('inventory').classList.remove('hidden');
      displayInventory();
    }

// Cam√©ra + lecture code
async function startCamera() {
  const readerDiv = document.getElementById("reader");
  const output = document.getElementById("manualInput");

  // üß† Si BarcodeDetector est disponible (Android natif)
  if ('BarcodeDetector' in window) {
    const formats = ['qr_code', 'ean_13', 'code_128', 'code_39'];
    const detector = new BarcodeDetector({ formats });
    const video = document.createElement('video');
    video.autoplay = true;
    video.style.width = "100%";
    video.style.borderRadius = "8px";
    readerDiv.innerHTML = "";
    readerDiv.appendChild(video);

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;

      const scan = async () => {
        if (!stream.active) return;
        const barcodes = await detector.detect(video);
        if (barcodes.length > 0) {
          const code = barcodes[0].rawValue;
          output.value = code;
          handleSubmit(); // ajoute directement √† l‚Äôinventaire
          alert("‚úÖ Code d√©tect√© : " + code);
          // stoppe la cam√©ra proprement
          stream.getTracks().forEach(track => track.stop());
          readerDiv.innerHTML = "";
        } else {
          requestAnimationFrame(scan);
        }
      };
      scan();
    } catch (err) {
      alert("Erreur cam√©ra (BarcodeDetector): " + err);
    }
  }

  // üß© Sinon, fallback sur html5-qrcode (iPhone, Safari‚Ä¶)
  else {
    html5QrCode = new Html5Qrcode("reader");
    const config = {
      fps: 10,
      qrbox: 250,
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39
      ]
    };

    try {
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          output.value = decodedText;
          handleSubmit(); // ajoute direct
          alert("‚úÖ Code d√©tect√© : " + decodedText);
          html5QrCode.stop();
        }
      );
    } catch (err) {
      alert("Erreur cam√©ra (html5-qrcode): " + err);
    }
  }
}

function stopCamera() {
  // Stop html5-qrcode s‚Äôil est actif
  if (html5QrCode) {
    html5QrCode.stop().catch(()=>{}).finally(()=>{
      document.getElementById("reader").innerHTML = "";
    });
  }
  // Nettoyage du lecteur
  document.getElementById("reader").innerHTML = "";
}

    // Quantit√©
    function increaseQty(){const i=document.getElementById('quantity');i.value=parseInt(i.value)+1;}
    function decreaseQty(){const i=document.getElementById('quantity');i.value=Math.max(1,parseInt(i.value)-1);}

    // Enregistrement
    function handleSubmit(){
      const code=document.getElementById('manualInput').value.trim();
      const qty=parseInt(document.getElementById('quantity').value);
      if(!code) return;
      if(currentMode==='entry'){inventory[code]=(inventory[code]||0)+qty;}
      else if(currentMode==='exit'){
        const newQty=(inventory[code]||0)-qty;
        if(newQty<=0) delete inventory[code]; else inventory[code]=newQty;
      }
      saveInventory();
      resetForm();
    }
    function resetForm(){
      document.getElementById('manualInput').value='';
      document.getElementById('quantity').value=1;
    }

    // Inventaire
    function displayInventory(){
      const search=document.getElementById('searchInput').value.toLowerCase();
      const list=document.getElementById('inventoryList');
      const empty=document.getElementById('emptyState');
      const filtered=Object.entries(inventory)
        .filter(([code])=>code.toLowerCase().includes(search))
        .sort(([a],[b])=>a.localeCompare(b));
      if(filtered.length===0){
        empty.classList.remove('hidden');list.innerHTML='';
      }else{
        empty.classList.add('hidden');
        list.innerHTML=filtered.map(([c,q])=>`
          <div class="inventory-item"><div class="item-code">${c}</div><div class="item-qty">${q}</div></div>
        `).join('');
      }
    }
    function filterInventory(){displayInventory();}

    // Service Worker
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js');
      });
    }

    loadInventory();
  </script>
</body>
</html>

