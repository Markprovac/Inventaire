<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Application de gestion de stock de pi√®ces automobiles">
  <meta name="theme-color" content="#1e3a8a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%231e3a8a'/%3E%3Cpath fill='white' d='M96 48L48 72v48l48 24 48-24V72L96 48zm0 16l32 16v32l-32 16-32-16V80l32-16z'/%3E%3C/svg%3E">
  <title>Stock Pi√®ces Auto</title>
 
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh}
    .hidden{display:none!important}
    #home{min-height:100vh;background:linear-gradient(135deg,#1e3a8a 0%,#1e40af 100%);padding:24px}
    .container{max-width:448px;margin:0 auto}
    .header{text-align:center;margin-bottom:32px;color:white}
    .icon-large{width:80px;height:80px;margin:0 auto 16px}
    h1{font-size:1.875rem;font-weight:bold;margin-bottom:8px}
    .subtitle{color:#bfdbfe}
    .button-group{display:flex;flex-direction:column;gap:16px}
    .btn{width:100%;padding:24px;font-size:1.25rem;font-weight:bold;border:none;border-radius:12px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:.2s;
      box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .btn:hover{transform:scale(1.05)}
    .btn-entry{background:#22c55e;color:white}.btn-entry:hover{background:#16a34a}
    .btn-exit{background:#ef4444;color:white}.btn-exit:hover{background:#dc2626}
    .btn-inventory{background:white;color:#1e3a8a}.btn-inventory:hover{background:#f3f4f6}
    .stats{margin-top:32px;text-align:center;color:#bfdbfe;font-size:.875rem}
    #scan{min-height:100vh;background:#111827;color:white;padding:16px}
    .scan-header{display:flex;justify-content:space-between;align-items:center}
    .scan-title{font-size:1.5rem;font-weight:bold}
    .btn-close{background:#ef4444;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-close:hover{background:#dc2626}
    #reader{width:100%;max-width:400px;margin:20px auto}
    .manual-input{background:#1f2937;padding:24px;border-radius:8px;margin-top:16px}
    .manual-input h3{font-size:1.125rem;margin-bottom:16px}
    .input-field{width:100%;background:#374151;color:white;border:none;padding:12px 16px;
      border-radius:8px;margin-bottom:16px;font-size:1rem}
    .input-field:focus{outline:2px solid #3b82f6}
    .quantity-control{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .btn-qty{background:#374151;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-qty:hover{background:#4b5563}
    .qty-input{width:80px;background:#374151;color:white;border:none;padding:8px 12px;border-radius:8px;
      text-align:center;font-size:1rem}
    .btn-submit{width:100%;padding:12px 24px;font-weight:bold;border:none;border-radius:8px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px}
    #inventory{min-height:100vh;background:#f9fafb}
    .inventory-header{background:#1e3a8a;color:white;padding:16px}
    .inventory-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .inventory-title{font-size:1.5rem;font-weight:bold}
    .btn-header-close{background:#1e40af;color:white;border:none;padding:8px;border-radius:8px;cursor:pointer}
    .btn-header-close:hover{background:#1e3a8a}
    .search-container{position:relative}
    .search-input{width:100%;background:white;color:#111827;border:none;padding:12px 16px 12px 40px;
      border-radius:8px;font-size:1rem}
    .search-input:focus{outline:2px solid #93c5fd}
    .inventory-content{padding:16px}
    .empty-state{text-align:center;color:#6b7280;padding:48px 0}
    .inventory-item{background:white;padding:16px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1);
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .item-code{font-family:monospace;font-weight:600;color:#111827}
    .item-qty{background:#dbeafe;color:#1e3a8a;font-weight:bold;padding:8px 16px;border-radius:8px}
  </style>
  <style>
/* Animation de chargement */
.scanner-status {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: #003366;
  font-size: 1em;
  margin-top: 10px;
}
.loader {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #3498db;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin-bottom: 8px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body>
  <!-- Page d'accueil -->
  <div id="home">
    <div class="container">
      <div class="header">
        <svg class="icon-large" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
        </svg>
        <h1>Stock Pi√®ces V√©hicule</h1>
        <p class="subtitle">Gestion simplifi√©e de votre inventaire</p>
      </div>
      <div class="button-group">
        <button class="btn btn-entry" onclick="showScan('entry')">ENTR√âES</button>
        <button class="btn btn-exit" onclick="showScan('exit')">SORTIES</button>
        <button class="btn btn-inventory" onclick="showInventory()">INVENTAIRE</button>
      </div>
      <div class="stats">
        <p><span id="refCount">0</span> r√©f√©rences en stock</p>
        <p><span id="totalCount">0</span> pi√®ces au total</p>
      </div>
    </div>
  </div>

  <!-- Page scan -->
  <div id="scan" class="hidden">
    <div class="scan-header">
      <h2 class="scan-title" id="scanTitle">ENTR√âE</h2>
      <button class="btn-close" onclick="showHome()">Fermer</button>
    </div>

    <div id="reader"></div>

    <div class="manual-input">
      <h3>Saisie manuelle</h3>
      <input type="text" id="manualInput" class="input-field" placeholder="R√©f√©rence ou code-barres">
      <div class="quantity-control">
        <button class="btn-qty" onclick="decreaseQty()">-</button>
        <input type="number" id="quantity" class="qty-input" value="1" min="1">
        <button class="btn-qty" onclick="increaseQty()">+</button>
      </div>
      <button id="btnSubmit" class="btn-submit btn-entry" onclick="handleSubmit()">Ajouter au stock</button>
    </div>
  </div>

  <!-- Page inventaire -->
  <div id="inventory" class="hidden">
    <div class="inventory-header">
      <div class="inventory-top">
        <h2 class="inventory-title">Inventaire</h2>
        <button class="btn-header-close" onclick="showHome()">Fermer</button>
      </div>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Rechercher..." oninput="filterInventory()">
      </div>
    </div>
    <div class="inventory-content">
      <div id="emptyState" class="empty-state">Aucune pi√®ce en stock</div>
      <div id="inventoryList"></div>
    </div>
  </div>

  <script>
    let inventory = {}, currentMode = null, html5QrCode = null;

    // Charger / sauvegarder
    function loadInventory() {
      const saved = localStorage.getItem('partsInventory');
      if (saved) inventory = JSON.parse(saved);
      updateStats();
    }
    function saveInventory() {
      localStorage.setItem('partsInventory', JSON.stringify(inventory));
      updateStats();
    }
    function updateStats() {
      const refCount = Object.keys(inventory).length;
      const totalCount = Object.values(inventory).reduce((a,b)=>a+b,0);
      document.getElementById('refCount').textContent = refCount;
      document.getElementById('totalCount').textContent = totalCount;
    }

    // Navigation
    function showHome(){
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('scan').classList.add('hidden');
      document.getElementById('inventory').classList.add('hidden');
      stopCamera();
    }
    function showScan(mode){
      currentMode=mode;
      document.getElementById('home').classList.add('hidden');
      document.getElementById('scan').classList.remove('hidden');
      document.getElementById('inventory').classList.add('hidden');
      document.getElementById('scanTitle').textContent=mode==='entry'?'ENTR√âE':'SORTIE';
      const btn=document.getElementById('btnSubmit');
      btn.textContent=mode==='entry'?'Ajouter au stock':'Retirer du stock';
      btn.className='btn-submit '+(mode==='entry'?'btn-entry':'btn-exit');
      startCamera();
    }
    function showInventory(){
      document.getElementById('home').classList.add('hidden');
      document.getElementById('scan').classList.add('hidden');
      document.getElementById('inventory').classList.remove('hidden');
      displayInventory();
    }

// Cam√©ra + lecture code
/*async function startCamera() {
  const readerDiv = document.getElementById("reader");
  const output = document.getElementById("manualInput");
  readerDiv.innerHTML = "";

  // üß† Si BarcodeDetector est disponible (Android natif)
  if ('BarcodeDetector' in window) {
    const formats = ['qr_code', 'ean_13', 'code_128', 'code_39'];
    const detector = new BarcodeDetector({ formats });
    const video = document.createElement('video');
    video.autoplay = true;
    video.style.width = "100%";
    video.style.borderRadius = "8px";
    readerDiv.appendChild(video);

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;

      const scan = async () => {
        if (!stream.active) return;
        const barcodes = await detector.detect(video);
        if (barcodes.length > 0) {
          const code = barcodes[0].rawValue;
          output.value = code;
          handleSubmit(); // ajoute directement √† l‚Äôinventaire
          alert("‚úÖ Code d√©tect√© : " + code);
          stream.getTracks().forEach(track => track.stop());
          readerDiv.innerHTML = "";
        } else {
          requestAnimationFrame(scan);
        }
      };
      scan();
    } catch (err) {
      console.warn("Erreur cam√©ra (BarcodeDetector):", err);
      await tryOCRFallback(); // üîÅ Fallback OCR
    }
  }

  // üß© Sinon, fallback sur html5-qrcode (iPhone, Safari‚Ä¶)
  else {
    html5QrCode = new Html5Qrcode("reader");
    const config = {
      fps: 10,
      qrbox: 250,
      formatsToSupport: [
        Html5QrcodeSupportedFormats.QR_CODE,
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.CODE_128,
        Html5QrcodeSupportedFormats.CODE_39
      ]
    };

    try {
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          output.value = decodedText;
          handleSubmit(); // ajoute direct
          alert("‚úÖ Code d√©tect√© : " + decodedText);
          html5QrCode.stop();
        }
      );
    } catch (err) {
      console.warn("Erreur cam√©ra (html5-qrcode):", err);
      await tryOCRFallback(); // üîÅ Fallback OCR
    }
  }
}

// üß† OCR de secours avec Tesseract.js
async function tryOCRFallback() {
  alert("üì∏ Lecture code-barres impossible. Essayons la lecture texte (OCR).");

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.style.display = 'none';
  document.body.appendChild(input);

  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    alert("üîç Analyse de l‚Äôimage en cours, patiente un instant...");

    try {
      const { data: { text } } = await Tesseract.recognize(file, 'fra');
      const cleaned = text.replace(/\s+/g, '').trim();

      if (cleaned.length > 3) {
        document.getElementById('manualInput').value = cleaned;
        handleSubmit();
        alert("‚úÖ Texte d√©tect√© : " + cleaned);
      } else {
        alert("‚ùå Aucun texte lisible d√©tect√©.");
      }
    } catch (e) {
      console.error(e);
      alert("Erreur OCR : " + e.message);
    } finally {
      input.remove();
    }
  });

  input.click(); // Ouvre la cam√©ra pour prendre la photo
}

function stopCamera() {
  if (window.html5QrCode) {
    html5QrCode.stop().catch(()=>{}).finally(()=>{
      document.getElementById("reader").innerHTML = "";
    });
  }
  document.getElementById("reader").innerHTML = "";
}*/

    // Quantit√©
    function increaseQty(){const i=document.getElementById('quantity');i.value=parseInt(i.value)+1;}
    function decreaseQty(){const i=document.getElementById('quantity');i.value=Math.max(1,parseInt(i.value)-1);}

    // Enregistrement
    function handleSubmit(){
      const code=document.getElementById('manualInput').value.trim();
      const qty=parseInt(document.getElementById('quantity').value);
      if(!code) return;
      if(currentMode==='entry'){inventory[code]=(inventory[code]||0)+qty;}
      else if(currentMode==='exit'){
        const newQty=(inventory[code]||0)-qty;
        if(newQty<=0) delete inventory[code]; else inventory[code]=newQty;
      }
      saveInventory();
      resetForm();
    }
    function resetForm(){
      document.getElementById('manualInput').value='';
      document.getElementById('quantity').value=1;
    }

    // Inventaire
    function displayInventory(){
      const search=document.getElementById('searchInput').value.toLowerCase();
      const list=document.getElementById('inventoryList');
      const empty=document.getElementById('emptyState');
      const filtered=Object.entries(inventory)
        .filter(([code])=>code.toLowerCase().includes(search))
        .sort(([a],[b])=>a.localeCompare(b));
      if(filtered.length===0){
        empty.classList.remove('hidden');list.innerHTML='';
      }else{
        empty.classList.add('hidden');
        list.innerHTML=filtered.map(([c,q])=>`
          <div class="inventory-item"><div class="item-code">${c}</div><div class="item-qty">${q}</div></div>
        `).join('');
      }
    }
    function filterInventory(){displayInventory();}

    // Service Worker
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js');
      });
    }

    loadInventory();
  </script>
  <script>
let html5QrCode = null;
let currentStream = null;
let scanTimeout = null;

function showStatus(message) {
  const readerDiv = document.getElementById("reader");
  let status = document.getElementById("scanStatus");
  if (!status) {
    status = document.createElement("div");
    status.id = "scanStatus";
    status.className = "scanner-status";
    status.innerHTML = `<div class="loader"></div><span>${message}</span>`;
    readerDiv.appendChild(status);
  } else {
    status.querySelector("span").textContent = message;
  }
}

function removeStatus() {
  const status = document.getElementById("scanStatus");
  if (status) status.remove();
}

// D√©marre la lecture
async function startCamera() {
  const readerDiv = document.getElementById("reader");
  const output = document.getElementById("manualInput");
  readerDiv.innerHTML = "";
  showStatus("üîç Recherche du code-barres...");

  // ‚öôÔ∏è √âtape 1 : BarcodeDetector
  if ('BarcodeDetector' in window) {
    const formats = ['qr_code', 'ean_13', 'code_128', 'code_39'];
    const detector = new BarcodeDetector({ formats });
    const video = document.createElement('video');
    video.autoplay = true;
    video.style.width = "100%";
    video.style.borderRadius = "8px";
    readerDiv.appendChild(video);

    try {
      currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = currentStream;

      const scan = async () => {
        if (!currentStream?.active) return;
        const barcodes = await detector.detect(video);
        if (barcodes.length > 0) {
          const code = barcodes[0].rawValue.trim();
          onCodeDetected(code);
          return;
        }
        requestAnimationFrame(scan);
      };
      scan();

      // ‚è≥ Apr√®s 5 secondes, si rien trouv√© ‚Üí passe au html5-qrcode
      scanTimeout = setTimeout(() => {
        console.log("‚è≠Ô∏è Passage √† html5-qrcode (aucune lecture BarcodeDetector)");
        stopCamera();
        startHtml5QrCode();
      }, 5000);

    } catch (err) {
      console.warn("Erreur BarcodeDetector:", err);
      startHtml5QrCode();
    }

  } else {
    startHtml5QrCode();
  }
}

// ‚öôÔ∏è √âtape 2 : html5-qrcode
async function startHtml5QrCode() {
  const readerDiv = document.getElementById("reader");
  showStatus("‚è≠Ô∏è Recherche avec html5-qrcode...");

  html5QrCode = new Html5Qrcode("reader");
  const config = {
    fps: 10,
    qrbox: 250,
    formatsToSupport: [
      Html5QrcodeSupportedFormats.QR_CODE,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.CODE_39
    ]
  };

  try {
    await html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        const code = decodedText.trim();
        onCodeDetected(code);
        html5QrCode.stop();
      }
    );

    // ‚è≥ Apr√®s 5 secondes sans lecture ‚Üí OCR fallback
    scanTimeout = setTimeout(() => {
      console.log("‚è≠Ô∏è Passage √† OCR (aucune lecture html5-qrcode)");
      stopCamera();
      tryOCRFallback();
    }, 5000);

  } catch (err) {
    console.warn("Erreur html5-qrcode:", err);
    tryOCRFallback();
  }
}

// ‚úÖ Code d√©tect√©
function onCodeDetected(code) {
  clearTimeout(scanTimeout);
  stopCamera();
  removeStatus();

  const output = document.getElementById("manualInput");
  output.value = code;

  const readerDiv = document.getElementById("reader");
  readerDiv.innerHTML = `
    <div style="text-align:center;">
      <p>‚úÖ Code d√©tect√© : <strong>${code}</strong></p>
      <p>Tu peux modifier ci-dessous si besoin :</p>
      <input id="editCode" value="${code}" style="padding:8px; width:80%; font-size:1em; text-align:center;">
      <br><br>
      <button id="confirmBtn" style="padding:8px 16px; font-size:1em; background:#27ae60; color:white; border:none; border-radius:6px;">
        ‚úÖ Valider / Ajouter
      </button>
    </div>
  `;

  document.getElementById("confirmBtn").onclick = () => {
    const finalValue = document.getElementById("editCode").value.trim();
    output.value = finalValue;
    handleSubmit(); // ajoute √† l‚Äôinventaire
    readerDiv.innerHTML = "";
    alert("‚úÖ Code ajout√© : " + finalValue);
  };
}

// üß† √âtape 3 : OCR
async function tryOCRFallback() {
  removeStatus();
  showStatus("üì∏ Lecture texte (OCR) en cours...");

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.style.display = 'none';
  document.body.appendChild(input);

  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    showStatus("üîç Analyse de l‚Äôimage...");

    try {
      const { data: { text } } = await Tesseract.recognize(file, 'fra');
      const cleaned = text.replace(/\s+/g, '').trim();

      if (cleaned.length > 3) {
        removeStatus();
        onCodeDetected(cleaned);
      } else {
        removeStatus();
        alert("‚ùå Aucun texte lisible d√©tect√©.");
      }
    } catch (e) {
      console.error("Erreur OCR:", e);
      removeStatus();
      alert("Erreur OCR : " + e.message);
    } finally {
      input.remove();
    }
  });

  input.click();
}

// üßπ Arr√™t propre
function stopCamera() {
  clearTimeout(scanTimeout);
  removeStatus();

  if (currentStream) {
    currentStream.getTracks().forEach(track => track.stop());
    currentStream = null;
  }
  if (html5QrCode) {
    html5QrCode.stop().catch(()=>{}).finally(()=>{
      html5QrCode = null;
    });
  }
  document.getElementById("reader").innerHTML = "";
}
</script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</body>
</html>

